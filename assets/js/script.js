const buttons = {
    button0: {
        code: 'Backquote',
        key: '~',
        keyUp: '`',
        keyRus: 'ё',
        keyRusUp: 'Ё'
    },
    button1: {
        code: 'Digit1',
        key: '!',
        keyUp: '1',
        keyRus: '!',
        keyRusUp: '1'
    },
    button2: {
        code: 'Digit2',
        key: '@',
        keyUp: '2',
        keyRus: '"',
        keyRusUp: '2'
    },
    button3: {
        code: 'Digit3',
        key: '#',
        keyUp: '3',
        keyRus: '№',
        keyRusUp: '3'
    },
    button4: {
        code: 'Digit4',
        key: '$',
        keyUp: '4',
        keyRus: ';',
        keyRusUp: '4'
    },
    button5: {
        code: 'Digit5',
        key: '%',
        keyUp: '5',
        keyRus: '%',
        keyRusUp: '5'
    },
    button6: {
        code: 'Digit6',
        key: '^',
        keyUp: '6',
        keyRus: ':',
        keyRusUp: '6'
    },
    button7: {
        code: 'Digit7',
        key: '&',
        keyUp: '7',
        keyRus: '?',
        keyRusUp: '7'
    },
    button8: {
        code: 'Digit8',
        key: '*',
        keyUp: '8',
        keyRus: '*',
        keyRusUp: '8'
    },
    button9: {
        code: 'Digit9',
        key: '(',
        keyUp: '9',
        keyRus: '(',
        keyRusUp: '9'
    },
    button10: {
        code: 'Digit0',
        key: ')',
        keyUp: '0',
        keyRus: ')',
        keyRusUp: '0'
    },
    button11: {
        code: 'Minus',
        key: '-',
        keyUp: '_',
        keyRus: '-',
        keyRusUp: '_'
    },
    button12: {
        code: 'Equal',
        key: '=',
        keyUp: '+',
        keyRus: '=',
        keyRusUp: '+'
    },
    button13: {
        code: 'Backspace',
        key: 'Backspace',
        keyUp: 'Backspace',
        keyRus: 'Backspace',
        keyRusUp: 'Backspace'
    },
    button14: {
        code: 'Tab',
        key: 'Tab',
        keyUp: 'Tab',
        keyRus: 'Tab',
        keyRusUp: 'Tab'
    },
    button15: {
        code: 'KeyQ',
        key: 'q',
        keyUp: 'Q',
        keyRus: 'й',
        keyRusUp: 'Й'
    },
    button16: {
        code: 'KeyW',
        key: 'w',
        keyUp: 'W',
        keyRus: 'ц',
        keyRusUp: 'Ц'
    },
    button17: {
        code: 'KeyE',
        key: 'e',
        keyUp: 'E',
        keyRus: 'у',
        keyRusUp: 'У'
    },
    button18: {
        code: 'KeyR',
        key: 'r',
        keyUp: 'R',
        keyRus: 'к',
        keyRusUp: 'К'
    },
    button19: {
        code: 'KeyT',
        key: 't',
        keyUp: 'T',
        keyRus: 'е',
        keyRusUp: 'Е'
    },
    button20: {
        code: 'KeyY',
        key: 'y',
        keyUp: 'Y',
        keyRus: 'н',
        keyRusUp: 'Н'
    },
    button21: {
        code: 'KeyU',
        key: 'u',
        keyUp: 'U',
        keyRus: 'г',
        keyRusUp: 'Г'
    },
    button22: {
        code: 'KeyI',
        key: 'i',
        keyUp: 'I',
        keyRus: 'ш',
        keyRusUp: 'Ш'
    },
    button23: {
        code: 'KeyO',
        key: 'o',
        keyUp: 'O',
        keyRus: 'щ',
        keyRusUp: 'Щ'
    },
    button24: {
        code: 'KeyP',
        key: 'p',
        keyUp: 'P',
        keyRus: 'з',
        keyRusUp: 'З'
    },
    button25: {
        code: 'BracketLeft',
        key: '[',
        keyUp: '{',
        keyRus: 'х',
        keyRusUp: 'Х'
    },
    button26: {
        code: 'BracketRight',
        key: ']',
        keyUp: '}',
        keyRus: 'ъ',
        keyRusUp: 'Ъ'
    },
    button27: {
        code: 'Backslash',
        key: '&#92;',
        keyUp: '|',
        keyRus: '&#92;',
        keyRusUp: '/'
    },
    button28: {
        code: 'Delete',
        key: 'DEL',
        keyUp: 'DEL',
        keyRus: 'DEL',
        keyRusUp: 'DEL'
    },
    button29: {
        code: 'CapsLock',
        key: 'Caps Lock',
        keyUp: 'Caps Lock',
        keyRus: 'Caps Lock',
        keyRusUp: 'Caps Lock'
    },
    button30: {
        code: 'KeyA',
        key: 'a',
        keyUp: 'A',
        keyRus: 'ф',
        keyRusUp: 'Ф'
    },
    button31: {
        code: 'KeyS',
        key: 's',
        keyUp: 'S',
        keyRus: 'ы',
        keyRusUp: 'Ы'
    },
    button32: {
        code: 'KeyD',
        key: 'd',
        keyUp: 'D',
        keyRus: 'в',
        keyRusUp: 'В'
    },
    button33: {
        code: 'KeyF',
        key: 'f',
        keyUp: 'F',
        keyRus: 'а',
        keyRusUp: 'А'
    },
    button34: {
        code: 'KeyG',
        key: 'g',
        keyUp: 'G',
        keyRus: 'п',
        keyRusUp: 'П'
    },
    button35: {
        code: 'KeyH',
        key: 'h',
        keyUp: 'H',
        keyRus: 'р',
        keyRusUp: 'Р'
    },
    button36: {
        code: 'KeyJ',
        key: 'j',
        keyUp: 'J',
        keyRus: 'о',
        keyRusUp: 'О'
    },
    button37: {
        code: 'KeyK',
        key: 'k',
        keyUp: 'K',
        keyRus: 'л',
        keyRusUp: 'Л'
    },
    button38: {
        code: 'KeyL',
        key: 'l',
        keyUp: 'L',
        keyRus: 'д',
        keyRusUp: 'Д'
    },
    button39: {
        code: 'Semicolon',
        key: ';',
        keyUp: ':',
        keyRus: 'ж',
        keyRusUp: 'Ж'
    },
    button40: {
        code: 'Quote',
        key: "'",
        keyUp: '"',
        keyRus: 'э',
        keyRusUp: 'Э'
    },
    button41: {
        code: 'Enter',
        key: 'ENTER',
        keyUp: 'ENTER',
        keyRus: 'ENTER',
        keyRusUp: 'ENTER'
    },
    button42: {
        code: 'ShiftLeft',
        key: 'Shift',
        keyUp: 'Shift',
        keyRus: 'Shift',
        keyRusUp: 'Shift'
    },
    button43: {
        code: 'AdditionSlash',
        key: '&#92;',
        keyUp: '&#92;',
        keyRus: '&#92;',
        keyRusUp: '&#92;'
    },
    button44: {
        code: 'KeyZ',
        key: 'z',
        keyUp: 'Z',
        keyRus: 'я',
        keyRusUp: 'Я'
    },
    button45: {
        code: 'KeyX',
        key: 'x',
        keyUp: 'X',
        keyRus: 'ч',
        keyRusUp: 'Ч'
    },
    button46: {
        code: 'KeyC',
        key: 'c',
        keyUp: 'C',
        keyRus: 'с',
        keyRusUp: 'С'
    },
    button47: {
        code: 'KeyV',
        key: 'v',
        keyUp: 'V',
        keyRus: 'м',
        keyRusUp: 'М'
    },
    button48: {
        code: 'KeyB',
        key: 'b',
        keyUp: 'B',
        keyRus: 'и',
        keyRusUp: 'И'
    },
    button49: {
        code: 'KeyN',
        key: 'n',
        keyUp: 'N',
        keyRus: 'т',
        keyRusUp: 'Т'
    },
    button50: {
        code: 'KeyM',
        key: 'm',
        keyUp: 'M',
        keyRus: 'ь',
        keyRusUp: 'Ь'
    },
    button51: {
        code: 'Comma',
        key: ',',
        keyUp: '<',
        keyRus: 'б',
        keyRusUp: 'Б'
    },
    button52: {
        code: 'Period',
        key: '.',
        keyUp: '>',
        keyRus: 'ю',
        keyRusUp: 'Ю'
    },
    button53: {
        code: 'Slash',
        key: '/',
        keyUp: '?',
        keyRus: '.',
        keyRusUp: ','
    },
    button54: {
        code: 'ArrowUp',
        key: '▲',
        keyUp: '▲',
        keyRus: '▲',
        keyRusUp: '▲'
    },
    button55: {
        code: 'ShiftRight',
        key: 'Shift',
        keyUp: 'Shift',
        keyRus: 'Shift',
        keyRusUp: 'Shift'
    },
    button56: {
        code: 'ControlLeft',
        key: 'Ctrl',
        keyUp: 'Ctrl',
        keyRus: 'Ctrl',
        keyRusUp: 'Ctrl'
    },
    button57: {
        code: 'MetaRight',
        key: 'Win',
        keyUp: 'Win',
        keyRus: 'Win',
        keyRusUp: 'Win'
    },
    button58: {
        code: 'AltLeft',
        key: 'Alt',
        keyUp: 'Alt',
        keyRus: 'Alt',
        keyRusUp: 'Alt'
    },
    button59: {
        code: 'Space',
        key: '______',
        keyUp: '______',
        keyRus: '______',
        keyRusUp: '______'
    },
    button60: {
        code: 'AltRight',
        key: 'Alt',
        keyUp: 'Alt',
        keyRus: 'Alt',
        keyRusUp: 'Alt'
    },
    button61: {
        code: 'ControlRight',
        key: 'Ctrl',
        keyUp: 'Ctrl',
        keyRus: 'Ctrl',
        keyRusUp: 'Ctrl'
    },
    button62: {
        code: 'ArrowLeft',
        key: '◄',
        keyUp: '◄',
        keyRus: '◄',
        keyRusUp: '◄'
    },
    button63: {
        code: 'ArrowDown',
        key: '▼',
        keyUp: '▼',
        keyRus: '▼',
        keyRusUp: '▼'
    },
    button64: {
        code: 'ArrowRight',
        key: '►',
        keyUp: '►',
        keyRus: '►',
        keyRusUp: '►'
    },
}

const nonUsableButtonsCodes = [112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 27, 45, 33, 34, 35, 36, 37, 38, 39, 40, 44, 145, 91, 92];

//add basic keyboard
function addKeyboard() {
    const container = document.createElement('div');
    container.classList.add('container');
    const input = document.createElement('textarea');
    input.classList.add('input');
    input.setAttribute('disabled', 'disabled');
    container.append(input);
    const keyboard = document.createElement('div');
    keyboard.classList.add('keyboard');

    let counter = 0;
    for (button in buttons) {
        const buttonIns = document.createElement('button');
        buttonIns.classList.add('button');
        if ((counter >= 0 && counter <= 12) ||
            (counter === 27) ||
            (counter === 39) ||
            (counter === 40) ||
            (counter === 53)
        ) {
            buttonIns.classList.add('button_with_upper_symbol');
        }
        buttonIns.id = 'button' + counter;
        const buttonValue = document.createElement('p');
        buttonValue.classList.add("main_symbol");
        buttonValue.innerHTML = buttons[button].keyUp;
        const upperSymbol = document.createElement('p');
        upperSymbol.classList.add("upper_symbol");
        upperSymbol.innerHTML = buttons[button].key;

        buttonIns.append(buttonValue);
        buttonIns.append(upperSymbol);
        keyboard.append(buttonIns);
        counter++;
    }

    container.append(keyboard);
    document.body.append(container);
    const noteForUser = document.createElement('p');
    noteForUser.classList.add('note-for-user');
    noteForUser.innerHTML = '* Для переключения раскладки клавиатуры нажмите одновременно Shift + Alt или Ctrl + Alt <br> * Клавиатура сохраняет раскладку при перезагрузке страницы и автоматически меняет язык раскладки на язык системы пользователя при необходимости <br> * Клавиатура создана для ОС Windows';
    container.append(noteForUser);
}

addKeyboard();

//add evenlistener for virtual buttons input
const indexButtons = document.querySelectorAll('.button');

indexButtons.forEach(indexButton => {
    indexButton.addEventListener('click', handleClick);
})

let isCaps = false;

function handleClick() {
    const indexInput = document.querySelector('.input');
    indexInput.removeAttribute('autofocus', 'autofocus');
    const thisInnerValue = this.querySelector(".button .main_symbol").innerHTML;
    if (thisInnerValue === 'Caps Lock') {
        if (isCaps) {
            isCaps = false;
            this.classList.remove('active-caps');
        } else {
            isCaps = true;
            this.classList.add('active-caps');
        }
    }
    else if (thisInnerValue === 'ENTER') {
        indexInput.value += '\n';
    }
    else if (thisInnerValue === 'Tab') {
        indexInput.value += '   ';
    }
    else if (thisInnerValue === '______') {
        indexInput.value += ' ';
    }
    else if (thisInnerValue === 'Backspace') {
        indexInput.value = indexInput.value.slice(0, indexInput.value.length - 1)
    }
    else if (
        thisInnerValue === 'Shift' ||
        thisInnerValue === 'Ctrl' ||
        thisInnerValue === 'Win' ||
        thisInnerValue === 'Alt' ||
        thisInnerValue === 'DEL' ||
        thisInnerValue === '▲' ||
        thisInnerValue === '►' ||
        thisInnerValue === '▼' ||
        thisInnerValue === '◄'
    ) {
        indexInput.value += '';
    }
    else {
        if (!isCaps) {
            indexInput.value += this.querySelector(".button .main_symbol").textContent.toLowerCase();
        } else {
            indexInput.value += this.querySelector(".button .upper_symbol").textContent.toUpperCase();
        }
    }
}

//input from PC keyboard
const cyrCodes = [1040, 1041, 1042, 1043, 1044, 1045, 1046, 1047, 1048, 1049, 1050, 1051, 1052, 1053, 1054, 1055, 1056, 1057, 1058, 1059, 1060, 1061, 1062, 1063, 1064, 1065, 1066, 1067, 1068, 1069, 1070, 1071, 1025, 1072, 1073, 1074, 1075, 1076, 1077, 1078, 1079, 1080, 1081, 1082, 1083, 1084, 1085, 1086, 1087, 1088, 1089, 1090, 1091, 1092, 1093, 1094, 1095, 1096, 1097, 1098, 1099, 1100, 1101, 1102, 1103, 1105];

const cyrLetters = ["А", "Б", "В", "Г", "Д", "Е", "Ж", "З", "И", "Й", "К", "Л", "М", "Н", "О", "П", "Р", "С", "Т", "У", "Ф", "Х", "Ц", "Ч", "Ш", "Щ", "Ъ", "Ы", "Ь", "Э", "Ю", "Я", "Ё", "а", "б", "в", "г", "д", "е", "ж", "з", "и", "й", "к", "л", "м", "н", "о", "п", "р", "с", "т", "у", "ф", "х", "ц", "ч", "ш", "щ", "ъ", "ы", "ь", "э", "ю", "я", "ё"];

document.addEventListener("keydown", inputFromKeyboard);

function inputFromKeyboard(event) {
    const indexInput = document.querySelector('.input');
    const thisInnerValue = event.key;
    const thisKeyCode = event.keyCode;
    const thisKeyCodeEng = event.code.replace('Key', '').toLowerCase();

    if (!isAutofocus) {
        //check if user's system language right and change virtual keyboard language, if it is not right
        if (thisInnerValue === thisKeyCodeEng
            && !((event.altKey && event.ctrlKey) || (event.altKey && event.shiftKey))
        ) {
            changeToEng();
        }
        else if (cyrLetters.includes(thisInnerValue)
            && !((event.altKey && event.ctrlKey) || (event.altKey && event.shiftKey))
        ) {
            changeToRus();
        }

        if (thisInnerValue === 'CapsLock') {
            if (isCaps) {
                isCaps = false;
                document.querySelector('#button29').classList.remove('active-caps');
            } else {
                isCaps = true;
                document.querySelector('#button29').classList.add('active-caps');
            }
        }
        else if (thisInnerValue === 'ENTER' || thisInnerValue === 'Enter') {
            event.preventDefault();
            indexInput.value += '\n';
        }
        else if (thisInnerValue === 'Backspace') {
            indexInput.value = indexInput.value.slice(0, indexInput.value.length - 1);
        }
        else if (thisInnerValue === ' ') {
            event.preventDefault();
            indexInput.value += ' ';
        }
        else if (thisInnerValue === 'Tab') {
            event.preventDefault();
            indexInput.value += '   ';
        }
        else if (
            thisInnerValue === 'Shift' ||
            thisInnerValue === 'Control' ||
            thisInnerValue === 'Win' ||
            thisInnerValue === 'Alt' ||
            thisInnerValue === 'AltGraph' ||
            thisInnerValue === 'Delete' ||
            thisInnerValue === 'ArrowUp' ||
            thisInnerValue === 'ArrowDown' ||
            thisInnerValue === 'ArrowLeft' ||
            thisInnerValue === 'ArrowRight' ||
            nonUsableButtonsCodes.includes(thisKeyCode)
        ) {
            event.preventDefault();
            indexInput.value += '';
        }
        else if (isCaps) {
            indexInput.value += event.key.toUpperCase();
        }
        else {
            indexInput.value += event.key;
        }
    }
}

//autofocus flag
const changeAutofocusFlagInput = document.querySelector('.input');

document.addEventListener('click', changeAutofocusFlag);

let isAutofocus = true;

function changeAutofocusFlag(event) {
    if (event.target === changeAutofocusFlagInput) {
        isAutofocus = true;
    } else {
        isAutofocus = false;
    }
}

//animation of keypress
document.addEventListener('keydown', focusButton);

function focusButton(event) {
    thisKey = event.code;
    indexButtons.forEach(button => {
        button.classList.remove('active');
    })
    let i = 0;
    for (button in buttons) {
        if (thisKey === buttons[button].code) {
            document.querySelector('#button' + i).classList.add('active');
        }
        i++;
    }
}

document.addEventListener('keyup', unFocusButton);

function unFocusButton() {
    indexButtons.forEach(button => {
        button.classList.remove('active');
    })
}

//language changing
let isEnglish = true;

window.addEventListener('load', changeLanguageOnLoad);
document.addEventListener('keydown', changeLanguageOnKeyEvent);

function changeLanguageOnKeyEvent(event) {
    if ((event.altKey && event.ctrlKey) || (event.altKey && event.shiftKey)) {
        changeLanguage();
    }
}

function changeLanguageOnLoad() {
    const preloadedLanguage = localStorage.getItem('virtualKeyboardLanguage');
    if (preloadedLanguage === 'english') {
        isEnglish = true;
    } else {
        isEnglish = false;
    }
    changeLanguage();
}

function changeLanguage() {
    if (isEnglish
    ) {
        changeToRus();
    }
    else {
        changeToEng();
    }
}

function changeToRus() {
    isEnglish = false;
    localStorage.setItem('virtualKeyboardLanguage', 'english');
    let i = 0;
    for (button in buttons) {
        const indexButton = document.querySelector('#button' + i);
        const buttonValue = indexButton.querySelector(".main_symbol");
        buttonValue.innerHTML = buttons[button].keyRusUp;
        const upperSymbol = indexButton.querySelector(".upper_symbol");
        upperSymbol.innerHTML = buttons[button].keyRus;
        i++;
    }
}
function changeToEng() {
    isEnglish = true;
    localStorage.setItem('virtualKeyboardLanguage', 'russian');
    let i = 0;
    for (button in buttons) {
        const indexButton = document.querySelector('#button' + i);
        const buttonValue = indexButton.querySelector(".main_symbol");
        buttonValue.innerHTML = buttons[button].keyUp;
        const upperSymbol = indexButton.querySelector(".upper_symbol");
        upperSymbol.innerHTML = buttons[button].key;
        i++;
    }
}


//autoscrolling to the end of the input
const indexInput = document.getElementsByTagName("textarea");
document.addEventListener('keyup', resizeInput);

function resizeInput() {
    indexInput[0].scrollTop = indexInput[0].scrollHeight;
}